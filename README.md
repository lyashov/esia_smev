# Инструкция по получению авторизационного кода и маркеров доступа через ЕСИА

Эта инструкция описывает процесс получения авторизационного кода, маркера идентификации и маркера доступа через систему ЕСИА, а также получение персональных данных пользователей.

## 1. Получение авторизационного кода

Чтобы получить авторизационный код, система-клиент должна получить разрешение на проведение аутентификации пользователя. Для этого пользователь должен быть направлен на страницу предоставления прав доступа в ЕСИА.

### Шаг 1: Направление пользователя на страницу авторизации

Адрес в тестовой среде:  
`https://esia-portal1.test.gosuslugi.ru/aas/oauth2/ac`

Ссылка должна содержать следующие обязательные параметры:

- **client_id** – Идентификатор системы-клиента в ЕСИА, например: `Weblp`.
- **client_secret** – Подпись запроса в формате PKCS#7 detached signature, закодированная в base64 url safe.
- **redirect_uri** – Ссылка, по которой пользователь будет перенаправлен после предоставления разрешения на аутентификацию, например: `https://szr.rt.ru/`.
- **scope** – Область доступа, например: `openid fullname birthdate gender snils inn id_doc`.
- **response_type** – Тип ответа от ЕСИА: `code`.
- **state** – UUID для защиты от перехвата.
- **timestamp** – Время запроса авторизационного кода в формате `yyyy.MM.dd HH:mm:ss Z`.

#### Пример запроса

https://esia-portal1.test.gosuslugi.ru/aas/oauth2/ac?timestamp=2015.11.27+13%3A03%3A52+%2B0300&scope=openid&client_secret=MIIFpgYJKoZIhvcNAQcCoIIFlzCCBZMCAQExDzANBglghkgBZQMEAgEFADALBgkqhkiG9w0BBwGgggNpMIIDZTCCAk2gAwIBAgIECgPdVzANBgkqhkiG9w0BAQsFADBjMQswCQYDVQQGEwJSVTEPMA0GA1UECBMGTW9zY293MQ8wDQYDVQQHEwZNb3Njb3cxEDAOBgNVBAoTB0NvbXBhbnkxDzANBgNVBAsTBlN5c3RlbTEPMA0GA1UEAxMGU3lzdGVtMB4XDTE1MTAyOTE0M...


#### Ошибки авторизации:

Если возникнут ошибки, ЕСИА вернет параметр `error` с кодом ошибки, например, `access_denied`. Перечень возможных ошибок описан в разделе **Приложения**.

---

## 2. Получение маркера идентификации

Когда авторизационный код получен, система-клиент может обменять его на маркер идентификации.

### Шаг 2: Запрос на получение маркера идентификации

Система-клиент формирует запрос методом **POST** на следующий адрес в тестовой среде:

https://esia-portal1.test.gosuslugi.ru/aas/oauth2/te


#### Обязательные параметры запроса:
- **client_id** – Идентификатор системы-клиента, например: `Weblp`.
- **code** – Авторизационный код, полученный от ЕСИА.
- **grant_type** – Значение: `authorization_code`.
- **client_secret** – Подпись запроса в формате PKCS#7.
- **state** – Новый UUID.
- **redirect_uri** – Та же ссылка, что и при запросе на получение авторизационного кода.
- **scope** – Та же область доступа.
- **timestamp** – Время запроса маркера в формате `yyyy.MM.dd HH:mm:ss Z`.
- **token_type** – Значение: `Bearer`.

#### Пример ответа:

```json
{
  "id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjFlOWdkazcifQ...",
  "expires_in": 3600,
  "state": "9be638a9-0e05-42e1-b4f8-a3e30457fbdd",
  "token_type": "Bearer"
}
```
3. Получение маркера доступа
   Маркеры доступа можно получить путем обмена авторизационного кода через тот же адрес ЕСИА:

## 3. Предоставление персональных данных пользователей
Для получения персональных данных пользователей, необходимо отправить запрос GET к API ЕСИА на следующий адрес:
https://esia-portal1.test.gosuslugi.ru/rs/prns
Запрос должен включать ресурс с необходимыми данными пользователя. Пример URL для запроса данных о пользователе:
GET /rs/prns/{oid}

Пример запроса:
```json
GET /rs/prns/6924 HTTP/1.1
Authorization: Bearer 75b2c7cbb8da403491c224c9e431cef9
Host: esia-portal1.test.gosuslugi.ru
Accept: */*
```
Пример ответа (данные адреса):
```josn
{
"stateFacts": ["Identifiable"],
"eTag": "672951A704B88A0063A35C3F49409152B087A49A",
"id": 21423,
"type": "PRG",
"region": "Воронежская Область",
"addressStr": "Воронежская область, Воронеж город, ПКрл Маяк-1 территория",
"city": "Воронеж Город",
"countryId": "RUS"
}
```


Закрытый ключ КриптоПро CSP представляет из себя флеш-накопитель, на котором в директории ххххх.000 лежат файлы primary.key, primary2.key, masks.key, masks2.key, name.key и header.key.


Такие ключи читаются только программой CryptoProJCP, серверная лицензия которой стоит на данный момент 120 тыс рублей.

Но наша задача – получить .p12 контейнер с наименьшими затратами.

C контейнером .p12 можно работать из java например с помощью библиотеки bouncycastle.

Но это уже тема следующей статьи.

Шаг 1.

Для экспорта ключа нам поможет замечательная утилита P12FromGostCSP, которая позволяет конвертировать ключ в формат .pfx

Мы вставляем флешку, запускаем утилиту и выбираем ключ для преобразования. Далее указываем пароль на хранилище и на выходе получим хранилище формата .pfx

Впрочем, это только начало, так как после конвертации контейнер все еще недоступен для чтения из java.

Шаг 2.

Далее нам потребуется с помощью OpenSSL извлечь закрытый ключ и сертификат и поместить их в .p12 хранилище.

Но есть проблема - OpenSSL из коробки не работает с алгоритмом ГОСТ 2012
Для этого нам потребуется программа openssl с поставленным на нее дополнением gost engine (ссылка тут). Нам необходимо установить это дополнение, следуя инструкциям, скомпилировав его из исходников.

Но есть вариант попроще...

Мы можем воспользоваться докер-контейнером, в котором уже установлен OpenSSL вместе с дополнением для корректной работы с алгоритмом ГОСТ 2012.

Ссылка на статью с описанием работы с данным докер-образом: Docker-образы с поддержкой ГОСТ-сертификатов в openssl, curl, php, nginx

В самом простом варианте нам требуется запустить этот докер-контейнер, подключиться к нему пробросив volume и выполнить пару консольных команд для извлечения закрытого ключа и сертификата из .pfx и помещения их в .p12

Запустим контейнер, пробросив папку tmp. В ней будем выполнять преобразования.

docker run -v "c:/tmp:/usr/tmp" --rm -i -t rnix/openssl-gost bash

Шаг 3.

#Достаем ключ
openssl pkcs12 -in gost.pfx -out gost.key -nocerts

#После команды задаем пароль для ключа.

#Достаем сертификат
openssl pkcs12 -in gost.pfx -out gost.cer -nokeys

#Объединяем их в хранилище p12, задавая ключу имя prod, его нужно будет прописать в application.properties как key.alias
openssl pkcs12 -export -inkey gost.key -in gost.cer -out gost.p12 -name prod

Полученное хранилище gost.p12 и сертификат gost.cer можно вставлять в папку resources/security. Не забываем указать все пароли и логины, а также имена файлов в application.properties.



